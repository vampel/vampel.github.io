<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vampire Deauther - Flipper Zero WiFi Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header {
            text-align: center;
            padding: 50px 20px;
            border-bottom: 1px solid #30363d;
        }
        h1 { 
            font-size: 3rem; 
            color: #58a6ff; 
            margin-bottom: 15px;
            font-weight: 700;
        }
        .subtitle { 
            font-size: 1.3rem; 
            color: #8b949e; 
            margin-bottom: 20px;
        }
        .hero-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        .download-card {
            background: #161b22;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }
        .download-card:hover {
            border-color: #58a6ff;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(88, 166, 255, 0.2);
        }
        .download-card h3 {
            color: #58a6ff;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .download-card p {
            color: #8b949e;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .download-card .size {
            color: #6e7681;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .btn {
            display: inline-block;
            padding: 14px 28px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background: #238636;
            color: white;
        }
        .btn-primary:hover {
            background: #2ea043;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(35, 134, 54, 0.4);
        }
        .btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
            border-color: #58a6ff;
        }
        .section {
            padding: 50px 20px;
            border-bottom: 1px solid #30363d;
        }
        .section h2 {
            font-size: 2.2rem;
            color: #58a6ff;
            margin-bottom: 30px;
            text-align: center;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .feature {
            display: flex;
            align-items: start;
            gap: 15px;
            padding: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
        }
        .feature-icon {
            font-size: 2rem;
            min-width: 40px;
        }
        .feature h4 {
            color: #c9d1d9;
            margin-bottom: 8px;
        }
        .feature p {
            color: #8b949e;
            font-size: 0.9rem;
        }
        .steps {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
        }
        .step {
            padding: 20px;
            margin: 15px 0;
            background: #0d1117;
            border-left: 4px solid #58a6ff;
            border-radius: 4px;
        }
        .step-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: #58a6ff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 12px;
            font-size: 1.1rem;
        }
        .wiring-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #161b22;
            border-radius: 6px;
            overflow: hidden;
        }
        .wiring-table th,
        .wiring-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }
        .wiring-table th {
            background: #0d1117;
            color: #58a6ff;
            font-weight: 600;
        }
        .wiring-table tr:hover {
            background: #1c2128;
        }
        code {
            background: #161b22;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #ff7b72;
            border: 1px solid #30363d;
        }
        .warning-box {
            background: #2d2a1f;
            border-left: 4px solid #d29922;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }
        .info-box {
            background: #1f2937;
            border-left: 4px solid #58a6ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }
        footer {
            text-align: center;
            padding: 40px 20px;
            color: #8b949e;
        }
        footer a {
            color: #58a6ff;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .hero-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶á Vampire Deauther 2.4Ghz & 5Ghz</h1>
            <p class="subtitle">WiFi Deauther & Beacon Spammer for Flipper Zero</p>
        </header>

        <!-- Downloads Section -->
        <div class="hero-section">
            <div class="download-card">
                <h3>üì¶ Flipper App</h3>
                <p>Install on your Flipper Zero to control the BW16 module</p>
                <a href="vampire_deauther.fap" download class="btn btn-primary">
                    Download FAP
                </a>
                <div class="size">~50 KB</div>
            </div>

            <div class="download-card">
                <h3>‚öôÔ∏è BW16 Firmware</h3>
                <p>Flash this firmware onto your BW16 (RTL8720DN) module</p>
                <a href="km0_km4_image2.bin" download class="btn btn-primary">
                    Download BIN
                </a>
                <div class="size">~450 KB</div>
            </div>

            <div class="download-card">
                <h3>üìñ Source Code</h3>
                <p>View the full project on GitHub</p>
                <a href="https://github.com/vampel/Vampire-Deauther" class="btn btn-secondary">
                    View on GitHub
                </a>
            </div>
        </div>

        <!-- Features -->
        <section class="section">
            <h2>‚ú® Features</h2>
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">üì°</div>
                    <div>
                        <h4>WiFi Scanning</h4>
                        <p>Detect nearby networks with channel and RSSI info</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">üéØ</div>
                    <div>
                        <h4>Deauth Attacks</h4>
                        <p>Target specific networks or all at once</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">üì¢</div>
                    <div>
                        <h4>Beacon Spam</h4>
                        <p>Create 50 fake APs with custom names</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">‚å®Ô∏è</div>
                    <div>
                        <h4>Custom SSID Editor</h4>
                        <p>Virtual keyboard for beacon names</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Web Flasher (Experimental) -->
        <section class="section">
            <h2>‚ö° Web Flasher (Experimental)</h2>
            
            <div class="warning-box">
                <strong>‚ö†Ô∏è Experimental Feature:</strong><br>
                Web-based flashing uses XMODEM protocol which may be unreliable via Web Serial API. 
                If it fails, use Arduino IDE method below. Requires Chrome/Edge/Opera browser.
            </div>

            <div class="steps">
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Prepare BW16</strong><br>
                    ‚Ä¢ Connect BW16 to LOG UART (PA7/PA8), NOT AT UART (PB1/PB2)<br>
                    ‚Ä¢ Enter bootloader: Hold <strong>BURN</strong> ‚Üí Press <strong>RST</strong> ‚Üí Release both
                </div>

                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Connect and Flash</strong><br>
                    <button id="connectBtn" class="btn btn-primary" style="margin: 10px 0;">
                        üîå Connect BW16
                    </button>
                    <button id="flashBtn" class="btn btn-secondary" style="margin: 10px 0;" disabled>
                        ‚ö° Flash Firmware
                    </button>
                </div>

                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Monitor Progress</strong><br>
                    <div id="progressContainer" style="width: 100%; height: 30px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; overflow: hidden; margin: 15px 0; display: none;">
                        <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #238636, #2ea043); width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500;">0%</div>
                    </div>
                    <div id="statusBox" style="background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 20px; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 13px; max-height: 300px; overflow-y: auto;">
                        <div style="color: #8b949e;">[INFO] Ready to flash. Click "Connect BW16" to begin.</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <strong>üí° Troubleshooting:</strong><br>
                ‚Ä¢ If connection fails: Check you're using LOG UART, not AT UART<br>
                ‚Ä¢ If flash fails: Use Arduino IDE method below (100% reliable)<br>
                ‚Ä¢ Supported browsers: Chrome, Edge, Opera (Web Serial API required)
            </div>
        </section>

        <!-- Flash Instructions -->
        <section class="section">
            <h2>‚ö° Flash BW16 Firmware</h2>
            
            <div class="info-box">
                <strong>üìã What you need:</strong><br>
                ‚Ä¢ BW16 (RTL8720DN) module<br>
                ‚Ä¢ USB cable<br>
                ‚Ä¢ Arduino IDE<br>
                ‚Ä¢ Downloaded <code>km0_km4_image2.bin</code>
            </div>

            <div class="steps">
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Install Arduino IDE</strong><br>
                    Download from <a href="https://www.arduino.cc/en/software" style="color: #58a6ff;">arduino.cc/en/software</a>
                </div>

                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Add RTL8720DN Board Support</strong><br>
                    ‚Ä¢ Open Arduino IDE ‚Üí File ‚Üí Preferences<br>
                    ‚Ä¢ Add to "Additional Boards Manager URLs":<br>
                    <code style="display: block; margin: 10px 0; padding: 10px;">https://github.com/ambiot/ambd_arduino/raw/master/Arduino_package/package_realtek.com_amebad_index.json</code>
                    ‚Ä¢ Tools ‚Üí Board ‚Üí Boards Manager<br>
                    ‚Ä¢ Search "Realtek Ameba" and click Install
                </div>

                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Prepare BW16</strong><br>
                    ‚Ä¢ Connect BW16 to computer via USB<br>
                    ‚Ä¢ <strong>For rtlduino boards:</strong> Short these pins:<br>
                    &nbsp;&nbsp;‚Ä¢ D0 ‚Üî D4 (PA7 ‚Üî PB1)<br>
                    &nbsp;&nbsp;‚Ä¢ D1 ‚Üî D5 (PA8 ‚Üî PB2)
                </div>

                <div class="step">
                    <span class="step-number">4</span>
                    <strong>Enter Bootloader Mode</strong><br>
                    ‚Ä¢ Hold <strong>BURN</strong> button<br>
                    ‚Ä¢ Press and release <strong>RST</strong> button<br>
                    ‚Ä¢ Release <strong>BURN</strong> button
                </div>

                <div class="step">
                    <span class="step-number">5</span>
                    <strong>Flash with Image Tool</strong><br>
                    Open terminal/command prompt and run:<br><br>
                    <strong>Windows:</strong>
                    <code style="display: block; margin: 5px 0; padding: 10px;">C:\Users\YourUser\AppData\Local\Arduino15\packages\realtek\tools\ameba_d_tools\1.0.5\windows\image_tool\amebad_image_tool.exe COM3</code>
                    
                    <strong>Mac:</strong>
                    <code style="display: block; margin: 5px 0; padding: 10px;">~/Library/Arduino15/packages/realtek/tools/ameba_d_tools/1.0.5/tools/macos/image_tool/amebad_image_tool /dev/cu.usbserial-*</code>
                    
                    <strong>Linux:</strong>
                    <code style="display: block; margin: 5px 0; padding: 10px;">~/.arduino15/packages/realtek/tools/ameba_d_tools/1.0.5/linux/image_tool/amebad_image_tool /dev/ttyUSB0</code>
                    
                    <br>Tool will guide you through flashing <code>km0_km4_image2.bin</code>
                </div>
            </div>
        </section>

        <!-- Hardware Setup -->
        <section class="section">
            <h2>üîß Connect to Flipper Zero</h2>
            
            <div class="warning-box">
                <strong>‚ö†Ô∏è Important:</strong> Power off Flipper before connecting wires!
            </div>

            <table class="wiring-table">
                <thead>
                    <tr>
                        <th>BW16 Pin</th>
                        <th>Flipper Zero Pin</th>
                        <th>Function</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>TX (PA7)</code></td>
                        <td><code>Pin 14 (RX)</code></td>
                        <td>UART Transmit</td>
                    </tr>
                    <tr>
                        <td><code>RX (PA8)</code></td>
                        <td><code>Pin 13 (TX)</code></td>
                        <td>UART Receive</td>
                    </tr>
                    <tr>
                        <td><code>3V3</code></td>
                        <td><code>Pin 9 (3.3V)</code></td>
                        <td>Power</td>
                    </tr>
                    <tr>
                        <td><code>GND</code></td>
                        <td><code>Pin 18 (GND)</code></td>
                        <td>Ground</td>
                    </tr>
                </tbody>
            </table>

            <div class="steps">
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Wire the modules</strong> following the table above
                </div>

                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Install FAP on Flipper</strong><br>
                    ‚Ä¢ Connect Flipper to PC<br>
                    ‚Ä¢ Copy <code>vampire_deauther.fap</code> to <code>/ext/apps/GPIO/</code><br>
                    ‚Ä¢ Disconnect and restart Flipper
                </div>

                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Launch the app</strong><br>
                    ‚Ä¢ Navigate to <strong>GPIO ‚Üí Vampire Deauther</strong><br>
                    ‚Ä¢ Enjoy! ü¶á
                </div>
            </div>
        </section>

        <!-- Legal -->
        <section class="section">
            <h2>‚öñÔ∏è Legal Notice</h2>
            <div class="warning-box">
                <p style="font-size: 1.1rem; margin-bottom: 10px;"><strong>‚ö†Ô∏è FOR EDUCATIONAL PURPOSES ONLY</strong></p>
                <p>This tool is intended for educational purposes and authorized security testing only. Unauthorized access to computer networks is illegal in most jurisdictions. Users are solely responsible for ensuring they have proper authorization before testing any networks. Use this tool only on networks you own or have explicit written permission to test.</p>
            </div>
        </section>

        <footer>
            <p style="font-size: 1.1rem; margin-bottom: 15px;">
                Made with ü¶á by <a href="https://github.com/vampel">Vampel</a>
            </p>
            <p>
                <a href="https://github.com/vampel/Vampire-Deauther">GitHub</a> ‚Ä¢ 
                <a href="https://github.com/vampel/Vampire-Deauther/issues">Report Issues</a> ‚Ä¢
                <a href="https://github.com/vampel/Vampire-Deauther/blob/main/LICENSE">License</a>
            </p>
        </footer>
    </div>
    <script type="module">
        // RTL8720DN Web Flasher - Optimized XMODEM at 115200 baud
        let port, reader, writer, connected = false;
        let readBuffer = [];

        const connectBtn = document.getElementById('connectBtn');
        const flashBtn = document.getElementById('flashBtn');
        const statusBox = document.getElementById('statusBox');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        // Logging
        function log(msg, type = 'info') {
            const colors = {
                info: '#58a6ff',
                success: '#3fb950',
                error: '#f85149',
                warning: '#d29922'
            };
            const div = document.createElement('div');
            div.style.color = colors[type] || colors.info;
            div.style.margin = '4px 0';
            const timestamp = new Date().toLocaleTimeString();
            div.textContent = `[${timestamp}] ${msg}`;
            statusBox.appendChild(div);
            statusBox.scrollTop = statusBox.scrollHeight;
        }

        function updateProgress(percent, text) {
            progressContainer.style.display = 'block';
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = text || `${percent}%`;
        }

        // XMODEM Constants
        const SOH = 0x01;
        const EOT = 0x04;
        const ACK = 0x06;
        const NAK = 0x15;
        const C = 0x43;

        // CRC-16/XMODEM
        function crc16(data) {
            let crc = 0;
            for (let i = 0; i < data.length; i++) {
                crc ^= data[i] << 8;
                for (let j = 0; j < 8; j++) {
                    crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                }
            }
            return crc & 0xFFFF;
        }

        // Binary reader (no text decoder for binary data)
        async function readByte(timeout = 3000) {
            const start = Date.now();
            
            while (Date.now() - start < timeout) {
                if (readBuffer.length > 0) {
                    return readBuffer.shift();
                }
                
                try {
                    const { value, done } = await Promise.race([
                        reader.read(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 50))
                    ]);
                    
                    if (done) throw new Error('Serial closed');
                    if (value) {
                        readBuffer.push(...value);
                    }
                } catch (e) {
                    if (e.message !== 'timeout') throw e;
                }
                
                await new Promise(r => setTimeout(r, 10));
            }
            
            throw new Error('Timeout reading byte');
        }

        async function waitForByte(expected, timeout = 3000) {
            const byte = await readByte(timeout);
            if (byte !== expected) {
                throw new Error(`Expected 0x${expected.toString(16).padStart(2, '0')}, got 0x${byte.toString(16).padStart(2, '0')}`);
            }
            return true;
        }

        async function writeBytes(data) {
            await writer.write(new Uint8Array(data));
        }

        async function xmodemSendFile(data, name) {
            log(`Starting XMODEM transfer of ${name}...`, 'info');
            
            // Wait for 'C' (CRC mode request)
            log('Waiting for receiver...', 'info');
            let attempts = 0;
            while (attempts < 60) {
                try {
                    const byte = await readByte(1000);
                    if (byte === C) {
                        log('‚úì Receiver ready!', 'success');
                        break;
                    }
                } catch (e) {
                    attempts++;
                    if (attempts % 10 === 0) {
                        log(`Still waiting... (${attempts}/60)`, 'warning');
                    }
                }
            }
            
            if (attempts >= 60) {
                throw new Error('Receiver not responding with C');
            }

            // Send packets
            const totalPackets = Math.ceil(data.length / 128);
            log(`Sending ${totalPackets} packets...`, 'info');
            
            for (let i = 0; i < totalPackets; i++) {
                const packetNum = (i + 1) % 256;
                const start = i * 128;
                const end = Math.min(start + 128, data.length);
                const chunk = new Uint8Array(128);
                
                // Fill chunk with data (pad with 0x1A if needed)
                for (let j = 0; j < 128; j++) {
                    chunk[j] = (start + j < data.length) ? data[start + j] : 0x1A;
                }
                
                // Build packet
                const packet = new Uint8Array(133);
                packet[0] = SOH;
                packet[1] = packetNum;
                packet[2] = 0xFF - packetNum;
                packet.set(chunk, 3);
                
                const crc = crc16(chunk);
                packet[131] = (crc >> 8) & 0xFF;
                packet[132] = crc & 0xFF;
                
                // Send with retries
                let sent = false;
                for (let retry = 0; retry < 10; retry++) {
                    try {
                        await writeBytes(packet);
                        await waitForByte(ACK, 2000);
                        sent = true;
                        break;
                    } catch (e) {
                        if (retry < 9) {
                            log(`Packet ${i + 1} retry ${retry + 1}`, 'warning');
                        }
                    }
                }
                
                if (!sent) {
                    throw new Error(`Failed to send packet ${i + 1} after 10 retries`);
                }
                
                // Update progress
                const percent = Math.floor(((i + 1) / totalPackets) * 100);
                if ((i + 1) % 5 === 0 || i === totalPackets - 1) {
                    updateProgress(percent, `${i + 1}/${totalPackets} packets`);
                }
            }
            
            // Send EOT
            log('Finalizing transfer...', 'info');
            await writeBytes([EOT]);
            await waitForByte(ACK, 2000);
            
            log(`‚úì ${name} transferred successfully!`, 'success');
        }

        async function enterBootloader() {
            log('Entering bootloader mode...', 'info');
            
            // Reset sequence via RTS/DTR
            await port.setSignals({ dataTerminalReady: false, requestToSend: true });
            await new Promise(r => setTimeout(r, 100));
            await port.setSignals({ dataTerminalReady: true, requestToSend: false });
            await new Promise(r => setTimeout(r, 300));
            
            log('‚úì Bootloader ready', 'success');
        }

        // Event handlers
        connectBtn.addEventListener('click', async () => {
            try {
                if (!('serial' in navigator)) {
                    log('ERROR: Web Serial API not supported', 'error');
                    log('Use Chrome, Edge, or Opera browser', 'error');
                    return;
                }

                log('Select your BW16 serial port...', 'info');
                port = await navigator.serial.requestPort();
                
                await port.open({ 
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: 'none'
                });
                
                // Binary reader
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                connected = true;
                log('‚úì Connected to BW16', 'success');
                log('Baudrate: 115200 bps', 'info');
                
                connectBtn.textContent = '‚úì Connected';
                connectBtn.disabled = true;
                flashBtn.disabled = false;

            } catch (error) {
                log(`Connection error: ${error.message}`, 'error');
            }
        });

        flashBtn.addEventListener('click', async () => {
            if (!connected) {
                log('ERROR: Not connected', 'error');
                return;
            }

            flashBtn.disabled = true;
            updateProgress(0, 'Starting...');
            
            try {
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                log('ü¶á VAMPIRE DEAUTHER FLASH', 'info');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                
                // Step 1: Enter bootloader
                updateProgress(5, 'Entering bootloader...');
                await enterBootloader();
                
                // Step 2: Load flash stub
                updateProgress(10, 'Loading flash stub...');
                log('Downloading flash stub...', 'info');
                
                const stubResp = await fetch('imgtool_flashloader_amebad.bin');
                if (!stubResp.ok) throw new Error('Flash stub not found');
                const stubData = new Uint8Array(await stubResp.arrayBuffer());
                
                log(`Flash stub: ${stubData.length} bytes`, 'info');
                await xmodemSendFile(stubData, 'Flash Stub');
                
                updateProgress(40, 'Flash stub loaded');
                await new Promise(r => setTimeout(r, 500));
                
                // Step 3: Flash firmware
                updateProgress(45, 'Loading firmware...');
                log('Downloading firmware...', 'info');
                
                const fwResp = await fetch('km0_km4_image2.bin');
                if (!fwResp.ok) throw new Error('Firmware not found');
                const fwData = new Uint8Array(await fwResp.arrayBuffer());
                
                log(`Firmware: ${fwData.length} bytes (~${Math.ceil(fwData.length/1024)}KB)`, 'info');
                log('This will take ~60 seconds at 115200 baud...', 'info');
                
                await xmodemSendFile(fwData, 'Firmware');
                
                updateProgress(100, '‚úì Complete!');
                
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
                log('‚úì FLASH COMPLETE!', 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
                log('', 'info');
                log('Next steps:', 'info');
                log('1. Disconnect BW16 from USB', 'info');
                log('2. Wire BW16 to Flipper Zero (see guide below)', 'info');
                log('3. Install vampire_deauther.fap on Flipper', 'info');
                log('4. Launch app: GPIO ‚Üí Vampire Deauther', 'info');
                
            } catch (error) {
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'error');
                log(`‚úó FLASH FAILED: ${error.message}`, 'error');
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'error');
                log('', 'warning');
                log('Troubleshooting:', 'warning');
                log('‚Ä¢ Make sure BW16 is in bootloader mode (BURN + RST)', 'warning');
                log('‚Ä¢ Check you\'re connected to LOG UART (PA7/PA8)', 'warning');
                log('‚Ä¢ Try Arduino IDE method below (100% reliable)', 'warning');
                
                flashBtn.disabled = false;
                updateProgress(0, 'Failed');
            }
        });
    </script>
</body>
</html>